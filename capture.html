<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upload Answer</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:#06152f;color:#eaf2ff;padding:16px}
    .card{width:min(520px,96vw);border:2px solid #f5c84b;border-radius:16px;padding:16px;background:rgba(0,0,0,0.25)}
    .btn{width:100%;border:2px solid #f5c84b;border-radius:999px;padding:12px 14px;background:#f5c84b;color:#0b1220;font-weight:900;cursor:pointer}
    .muted{opacity:0.85;font-size:13px;margin-top:10px}
    .status{margin-top:12px;font-weight:800}
    input{width:100%;margin:12px 0}
  </style>
</head>
<body>
  <div class="card">
    <div style="font-weight:1000;font-size:18px">Upload your answer photo</div>
    <div class="muted" id="cidLabel"></div>

    <input id="file" type="file" accept="image/*" capture="environment">

    <button class="btn" id="uploadBtn" type="button" disabled>Upload</button>
    <div class="status" id="status"></div>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  const cid = params.get('cid') || '';
  const cidLabel = document.getElementById('cidLabel');
  const fileInput = document.getElementById('file');
  const uploadBtn = document.getElementById('uploadBtn');
  const statusEl = document.getElementById('status');

  const API = 'https://script.google.com/macros/s/AKfycbzY4__WI7-VN86jNtr2jy3a9OG2YgQz-p54sRMZrVX9O-tVnsOFNyJlt2Z9UzVCg_e2ww/exec';

  cidLabel.textContent = cid ? ('Capture: ' + cid) : 'Missing cid';

  let selectedFile = null;

  fileInput.addEventListener('change', () => {
    selectedFile = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
    uploadBtn.disabled = !selectedFile || !cid;
    statusEl.textContent = '';
  });

  function loadImageFromFile(file) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });
  }

  async function compressToJpegBase64(file, maxW = 1600, quality = 0.75) {
    const img = await loadImageFromFile(file);

    const w = img.naturalWidth || img.width;
    const h = img.naturalHeight || img.height;

    const scale = Math.min(1, maxW / w);
    const nw = Math.max(1, Math.round(w * scale));
    const nh = Math.max(1, Math.round(h * scale));

    const canvas = document.createElement('canvas');
    canvas.width = nw;
    canvas.height = nh;

    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, nw, nh);

    const dataUrl = canvas.toDataURL('image/jpeg', quality);
    const base64 = dataUrl.split(',')[1];
    return base64;
  }

  uploadBtn.addEventListener('click', async () => {
    if (!selectedFile || !cid) return;

    uploadBtn.disabled = true;
    statusEl.textContent = 'Uploading...';

    try {
      // compress first to avoid Apps Script size limits
      const dataBase64 = await compressToJpegBase64(selectedFile, 1600, 0.75);

      const payload = {
        cid,
        filename: `ARUNNER_${cid}_${Date.now()}.jpg`,
        mimeType: 'image/jpeg',
        dataBase64
      };

      // IMPORTANT: text/plain avoids CORS preflight on iPhone Safari
      const res = await fetch(API + '?action=uploadImage', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch {}

      if (json && json.ok) {
        statusEl.textContent = 'Uploaded âœ… you can close this tab';
      } else {
        statusEl.textContent = 'Upload failed: ' + (json && json.error ? json.error : 'unknown');
        uploadBtn.disabled = false;
      }
    } catch (e) {
      statusEl.textContent = 'Upload error';
      uploadBtn.disabled = false;
    }
  });
</script>
</body>
</html>
