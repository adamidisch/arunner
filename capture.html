<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upload Answer</title>
  <style>
    body{font-family:Arial,sans-serif;margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:#06152f;color:#eaf2ff;padding:16px}
    .card{width:min(520px,96vw);border:2px solid #f5c84b;border-radius:16px;padding:16px;background:rgba(0,0,0,0.25)}
    .btn{width:100%;border:2px solid #f5c84b;border-radius:999px;padding:12px 14px;background:#f5c84b;color:#0b1220;font-weight:900;cursor:pointer}
    .muted{opacity:0.85;font-size:13px;margin-top:10px}
    .status{margin-top:12px;font-weight:800}
    input{width:100%;margin:12px 0}
  </style>
</head>
<body>
  <div class="card">
    <div style="font-weight:1000;font-size:18px">Upload your answer photo</div>
    <div class="muted" id="cidLabel"></div>

    <input id="file" type="file" accept="image/*" capture="environment">

    <button class="btn" id="uploadBtn" type="button" disabled>Upload</button>
    <div class="status" id="status"></div>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  const cid = params.get('cid') || '';
  const cidLabel = document.getElementById('cidLabel');
  const fileInput = document.getElementById('file');
  const uploadBtn = document.getElementById('uploadBtn');
  const statusEl = document.getElementById('status');

  const API = 'https://script.google.com/macros/s/AKfycbxSoLeN2iSaQkNr-DCgA_C3u_b4KuudIxyN-laJdPWKnZiUIa7VWc4AiAIT_28G_v7U0g/exec';

  cidLabel.textContent = cid ? ('Capture: ' + cid) : 'Missing cid';

  let selectedFile = null;

  fileInput.addEventListener('change', () => {
    selectedFile = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
    uploadBtn.disabled = !selectedFile || !cid;
    statusEl.textContent = '';
  });

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => {
        const res = String(r.result || '');
        const base64 = res.includes(',') ? res.split(',')[1] : res;
        resolve(base64);
      };
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  uploadBtn.addEventListener('click', async () => {
    if (!selectedFile || !cid) return;
    uploadBtn.disabled = true;
    statusEl.textContent = 'Uploading...';

    try {
      const dataBase64 = await fileToBase64(selectedFile);

      const payload = {
        cid,
        filename: selectedFile.name || 'answer.jpg',
        mimeType: selectedFile.type || 'image/jpeg',
        dataBase64
      };

      const res = await fetch(API + '?action=uploadImage', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      const json = await res.json();
      if (json && json.ok) {
        statusEl.textContent = 'Uploaded âœ… you can close this tab';
      } else {
        statusEl.textContent = 'Upload failed';
        uploadBtn.disabled = false;
      }
    } catch (e) {
      statusEl.textContent = 'Upload error';
      uploadBtn.disabled = false;
    }
  });
</script>
</body>
</html>
